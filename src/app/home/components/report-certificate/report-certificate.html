<div class="certificate-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <p>Loading certificate...</p>
  </div>

  <!-- PDF Generation Loading -->
  <div *ngIf="generatingPDF" class="pdf-loading-overlay">
    <div class="pdf-spinner"></div>
    <p>Generating PDF...</p>
    <p class="pdf-hint">This may take a few seconds</p>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage && !loading" class="error-state">
    <p>{{ errorMessage }}</p>
  </div>

  <!-- Certificate Content -->
  <div *ngIf="certificateData && !loading" class="certificate" id="certificate-content">
    <!-- Header -->
    <div class="certificate-header">
      <div class="logo-section">
        <div class="logo-placeholder">
          <img src="/assets/image/rma-logo-white.png" alt="RMA Logo" class="logo-img" id="rma-logo">
        </div>
      </div>
      <div class="title-section">
        <img 
          src="/assets/image/Rmalogotext.jpg" 
          alt="Royal Monetary Authority of Bhutan" 
          class="title-image"
          id="rma-title"
        />
      </div>
    </div>

    <h3 class="report-title">Certified Search Report</h3>

    <!-- Report Information -->
    <div class="report-info">
      <div class="info-row">
        <span class="label">Report Number:</span>
        <span class="value">{{ certificateData.reportNumber }}</span>
      </div>
      <div class="info-row">
        <span class="label">Report Type:</span>
        <span class="value">{{ certificateData.reportType === 'HIT_SEARCH' ? 'Hit Report' : certificateData.reportType }}</span>
      </div>
      <div class="info-row">
        <span class="label">Type of Search:</span>
        <span class="value">{{ getSearchTypeDisplay(certificateData.typeOfSearch) }}</span>
      </div>
      <div class="info-row">
        <span class="label">Purpose:</span>
        <span class="value">{{ certificateData.purpose }}</span>
      </div>
      <div class="info-row">
        <span class="label">Search Criteria:</span>
        <span class="value">{{ certificateData.searchedByCid || certificateData.vehicleOrPlotNo || 'N/A' }}</span>
      </div>
      <div class="info-row">
        <span class="label">Requested By:</span>
        <span class="value">{{ certificateData.requestedBy }}</span>
      </div>
      <div class="info-row">
        <span class="label">Date and Time of Search:</span>
        <span class="value">{{ formatDateTime(certificateData.dateTime) }}</span>
      </div>
      <div class="info-row">
        <span class="label">Collateral Type:</span>
        <span class="value">{{ certificateData.collateralType || 'N/A' }}</span>
      </div>
    </div>

    <!-- Search Result Section -->
    <div class="search-result-section" id="search-result-section">
      <h4 class="section-title">Search Result</h4>
      
      <!-- Display logic based on identifierType -->
      <div *ngIf="certificateData.collaterals && certificateData.collaterals.length > 0">
        
        <!-- For Immovable Property (identifierType = 'N') -->
        <ng-container *ngIf="certificateData.collaterals[0].identifierType === 'N'">
          <div class="table-wrapper">
            <table class="data-table" id="data-table">
              <thead>
                <tr>
                  <th>Reg. No</th>
                  <th>Owner Name</th>
                  <th>Institution</th>
                  <th>Branch</th>
                  <th>Dzongkhag</th>
                  <th>Village</th>
                  <th>Mobile</th>
                  <th>Email</th>
                  <th>Address</th>
                  <th>Plot ID</th>
                  <th *ngIf="certificateData.collaterals[0].collateralTypeSerialNo === '30'">Building ID</th>
                  <th *ngIf="certificateData.collaterals[0].collateralTypeSerialNo === '30'">Flat ID</th>
                  <th *ngIf="certificateData.collaterals[0].collateralTypeSerialNo === '31'">Building ID</th>
                  <th>Remarks</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let collateral of certificateData.collaterals">
                  <td>{{ collateral.registrationNo }}</td>
                  <td>{{ collateral.ownerName }}</td>
                  <td>{{ getSecuredPartyInstitutionName() }}</td>
                  <td>{{ getSecuredPartyBranchName() }}</td>
                  <td>{{ collateral.dzongkhagOrThromde }}</td>
                  <td>{{ collateral.thromdeOrVillageOrGewog }}</td>
                  <td>{{ collateral.mobileNumber }}</td>
                  <td>{{ collateral.email }}</td>
                  <td class="address-cell">{{ collateral.presentAddress }}</td>
                  <td>{{ collateral.plotId }}</td>
                  <td *ngIf="collateral.collateralTypeSerialNo === '30'">{{ collateral.buildingId || 'N/A' }}</td>
                  <td *ngIf="collateral.collateralTypeSerialNo === '30'">{{ collateral.flatId || 'N/A' }}</td>
                  <td *ngIf="collateral.collateralTypeSerialNo === '31'">{{ collateral.buildingId || 'N/A' }}</td>
                  <td>{{ collateral.remarks || 'N/A' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-container>

        <!-- For Movable Property - Individual (identifierType = 'S') -->
        <ng-container *ngIf="certificateData.collaterals[0].identifierType === 'S'">
          <div class="table-wrapper">
            <table class="data-table" id="data-table">
              <thead>
                <tr *ngIf="certificateData.typeOfSearch === 'ind'">
                  <th>Reg. No</th>
                  <th>Institution</th>
                  <th>Branch</th>
                  <th>ID No</th>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Vehicle No</th>
                  <th>Identifier</th>
                  <th>Details</th>
                </tr>
                <tr *ngIf="certificateData.typeOfSearch === 'ins'">
                  <th>Reg. No</th>
                  <th>Institution</th>
                  <th>Branch</th>
                  <th>Inst. No</th>
                  <th>Est. Name</th>
                  <th>Description</th>
                  <th>Vehicle No</th>
                  <th>Identifier</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let collateral of certificateData.collaterals">
                  <td>{{ collateral.registrationNo }}</td>
                  <td>{{ getSecuredPartyInstitutionName() }}</td>
                  <td>{{ getSecuredPartyBranchName() }}</td>
                  
                  <!-- For Individual search -->
                  <td *ngIf="certificateData.typeOfSearch === 'ind'">
                    {{ getDebtorIdentificationNo() || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ind'">
                    {{ getDebtorName() || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ind'">
                    {{ collateral.collateralIdentifierDesc || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ind'">
                    {{ collateral.vehicleNo || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ind'">
                    {{ collateral.collateralIdentifier || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ind'">
                    {{ collateral.collateralDesc || 'N/A' }}
                  </td>
                  
                  <!-- For Institution search -->
                  <td *ngIf="certificateData.typeOfSearch === 'ins'">
                    {{ getDebtorInstitutionNo() || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ins'">
                    {{ getDebtorEstablishmentName() || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ins'">
                    {{ collateral.collateralIdentifierDesc || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ins'">
                    {{ collateral.vehicleNo || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ins'">
                    {{ collateral.collateralIdentifier || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ins'">
                    {{ collateral.collateralDesc || 'N/A' }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-container>

        <!-- For Movable Property - Government (identifierType = 'G') -->
        <ng-container *ngIf="certificateData.collaterals[0].identifierType === 'G'">
          <div class="table-wrapper">
            <table class="data-table" id="data-table">
              <thead>
                <tr *ngIf="certificateData.typeOfSearch === 'ind'">
                  <th>Reg. No</th>
                  <th>Institution</th>
                  <th>Branch</th>
                  <th>ID No</th>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Identifier</th>
                  <th>Details</th>
                </tr>
                <tr *ngIf="certificateData.typeOfSearch === 'ins'">
                  <th>Reg. No</th>
                  <th>Institution</th>
                  <th>Branch</th>
                  <th>Inst. No</th>
                  <th>Est. Name</th>
                  <th>Description</th>
                  <th>Identifier</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let collateral of certificateData.collaterals">
                  <td>{{ collateral.registrationNo }}</td>
                  <td>{{ getSecuredPartyInstitutionName() }}</td>
                  <td>{{ getSecuredPartyBranchName() }}</td>
                  
                  <!-- For Individual search -->
                  <td *ngIf="certificateData.typeOfSearch === 'ind'">
                    {{ getDebtorIdentificationNo() || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ind'">
                    {{ getDebtorName() || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ind'">
                    {{ collateral.collateralIdentifierDesc || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ind'">
                    {{ collateral.collateralIdentifier || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ind'">
                    {{ collateral.collateralDesc || 'N/A' }}
                  </td>
                  
                  <!-- For Institution search -->
                  <td *ngIf="certificateData.typeOfSearch === 'ins'">
                    {{ getDebtorInstitutionNo() || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ins'">
                    {{ getDebtorEstablishmentName() || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ins'">
                    {{ collateral.collateralIdentifierDesc || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ins'">
                    {{ collateral.collateralIdentifier || 'N/A' }}
                  </td>
                  <td *ngIf="certificateData.typeOfSearch === 'ins'">
                    {{ collateral.collateralDesc || 'N/A' }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-container>
      </div>

      <!-- Mortgage Information Section -->
      <div *ngIf="showMortgageInfo()" class="mortgage-info-section">
        <div class="mortgage-content">
          <p>{{ getMortgageStatement() }}</p>
        </div>
      </div>
    </div>

    <!-- Footer Section -->
    <!-- <div class="certificate-footer" id="certificate-footer">
      <div class="footer-content">
        <p>POST BOX :154, CHHOPHEL LAM, KAWAJANOSA, THIMPHU BHUTAN</p>
        <p>TEL# :( +975-2-323110, 323111, 323112, 321699) FAX :( +975-2-322847)</p>
        <p>SWIFT: RMABBTBT</p>
      </div>
    </div> -->

    <!-- Action Buttons -->
    <div class="actions">
      <button class="download-btn" (click)="downloadCertificate()" [disabled]="generatingPDF">
        {{ generatingPDF ? 'Generating PDF...' : 'Download as PDF' }}
      </button>
    </div>
  </div>
</div>